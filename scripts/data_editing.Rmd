---
pagetitle: "Data Editing"
output: 
  html_document:
    toc: true
    toc_float: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output") 
  })
---

```{r packages data editing, include=FALSE}
# Package names
packages <- c("dplyr", "haven","lubridate","ggplot2", "corrplot", "psych",
              "readxl")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
```


First, we read in the main data set. 

```{r}

data<-read_dta(
  "../data/AIRBNB_Houseprices.dta",
  encoding = NULL,
  col_select = NULL,
  skip = 0,
  n_max = Inf,
  .name_repair = "unique"
)
control <- read_excel("../data/controls.xlsx")
tourist <- read.table("../data/tourist_coord.txt", stringsAsFactors = TRUE)
```

Transform data to factors, ordered etc., so that it can be properly read.
Take log size and price, because sizes are hugely skewed
```{r}
data$parking<-factor(data$parking)
data$pc4<-factor(data$pc4)
data$wtype<-factor(data$wtype)
data$construction_period<-factor(data$construction_period)
data$monumentalstatus<-factor(data$monumentalstatus)
data$buyerpaysorfree<-factor(data$buyerpaysorfree)
data$quality<-ordered(data$quality)
data$construction_period<-ordered(data$construction_period)
data$sales_date<-ymd(data$sales_date)
data$lprice <- log(data$price)
data$lsize <- log(data$size)
any(is.na(data))
```
add control variables
```{r}
control$year <- as.numeric(control$year)
data <- merge(data, control, all=TRUE, sort = FALSE)
```

read in tourist data with euclidean distance
```{r}
tourist$V1 <- as.numeric(as.character(tourist$V1))
euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))
loc <- data.frame(data$rd_x, data$rd_y)
euc.dist(loc[1,], tourist[1,])
data$tourist <- cdata$rd_x
```

Descriptive plots

```{r}
ggplot(data = data, aes(x= as.factor(year), y = lprice)) +
  geom_boxplot()+
  theme_bw()+
  labs(y= "Log Price", x = "Year" )+
  theme(text=element_text(family="serif"))
ggplot(data = data, aes(x= rd_x, y = rd_y, col = lprice)) +
  geom_point()+
  theme_bw()+
  labs(y= "Rd_y", x = "Rd_x" )+
  theme(text=element_text(family="serif"))

```

data cleansing for robust model
```{r}
boxplot(data$lprice)
pr_c <- quantile(data$lprice, c(0.99))
data_c <- subset(data, data$lprice<=pr_c)
boxplot(data_c$lsize)
si_c <- quantile(data_c$lsize, c(0.99))
data_c <- subset(data_c, data_c$lsize<=si_c)
boxplot(data_c$density)
de_c <- quantile(data_c$density, c(0.99))
data_c <- subset(data_c, data_c$density<=de_c)
boxplot(data_c$rooms)
ro_c <- quantile(data_c$rooms, c(0.99))
data_c <- subset(data_c, data_c$rooms<=ro_c)
```

finding cut points

```{r}
tmp <- data
tmp$year <- as.numeric(as.character(tmp$year))
data_causal1 <- subset(tmp, tmp$year>=2014 & tmp$year<=2017)
data_causal2 <- subset(tmp, tmp$year>=2009 & tmp$year<=2012)

tmp <- data_c
tmp$year <- as.numeric(as.character(tmp$year))
data_causal1_c <- subset(tmp, tmp$year>=2014 & tmp$year<=2017)
data_causal2_c <- subset(tmp, tmp$year>=2009 & tmp$year<=2012)

```

table original data
```{r}
names <- c("quality", "density", "garden" , "lsize"  ,              "volume"  , "rooms", "parking", "buyerpaysorfree" ,    "lprice")
data2 <- data[,which(colnames(data) %in% names)]
kable(describe(data2, omit=TRUE), caption = "Summary statistics", digits=3)
```
table cleaned data

```{r}
data2_c <- data_c[,which(colnames(data_c) %in% names)]
kable(describe(data2_c, omit=TRUE), caption = "Summary statistics", digits=3)
```